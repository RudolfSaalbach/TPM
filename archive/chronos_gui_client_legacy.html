<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chronos ‚Äì Event Manager v2.2 (Refactored)</title>
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Premium CSS -->
    <link rel="stylesheet" href="/static/css/chronos-momentum.css">
    
    <style>
        .client-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
        }
        .client-main {
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            height: 100%;
            overflow: hidden;
        }
        .events-list-container {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-auto-rows: min-content;
            gap: var(--spacing-md);
        }
        .template-list-item {
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-md);
            border: 1px solid transparent;
        }
        .template-list-item:hover {
            background-color: var(--surface-hover);
            border-color: var(--border);
        }
    </style>
</head>
<body class="chronos-app">
<div class="app-container client-container" id="app">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">Kalender-Filter</h2>
        </div>
        <div class="sidebar-content">
            <div class="form-group">
                <label for="range-select" class="form-label">Zeitbereich</label>
                <select id="range-select" class="form-select">
                    <option value="7">7 Tage</option>
                    <option value="14">14 Tage</option>
                    <option value="30">30 Tage</option>
                    <option value="60">60 Tage</option>
                    <option value="360">360 Tage</option>
                    <option value="-1">Alle Events</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Richtung</label>
                <div class="btn-group">
                    <input type="radio" class="btn-check" name="direction" id="dir-past" value="past">
                    <label class="btn btn-secondary" for="dir-past">Vergangenheit</label>
                    <input type="radio" class="btn-check" name="direction" id="dir-future" value="future" checked>
                    <label class="btn btn-secondary" for="dir-future">Zukunft</label>
                    <input type="radio" class="btn-check" name="direction" id="dir-all" value="all">
                    <label class="btn btn-secondary" for="dir-all">Alle</label>
                </div>
            </div>
            <div class="form-group">
                <label for="search-input" class="form-label">Suche</label>
                <input id="search-input" type="text" class="form-input" placeholder="Titel/Beschreibung...">
            </div>
            <div class="form-actions">
                <button id="btn-new" class="btn btn-secondary">Neuer Termin</button>
                <button id="btn-templates" class="btn btn-primary">Vorlage nutzen</button>
            </div>
        </div>
    </aside>

    <main class="client-main">
        <header class="navbar">
            <div class="navbar-brand">
                <h1 class="navbar-title">Events</h1>
                <p class="navbar-subtitle" id="status" role="status" aria-live="polite">Bereit</p>
            </div>
            <div class="navbar-actions">
                <div class="status-badge">
                    <span>Events:</span>
                    <span class="badge" id="kpi-count">‚Äî</span>
                </div>
            </div>
        </header>
        <section id="list" class="events-list-container" aria-busy="false" aria-label="Eventliste">
            </section>
    </main>
</div>

<dialog id="tplDialog" class="modal" aria-modal="true" aria-labelledby="tplTitle">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-lg">
        <header class="modal-header">
            <h2 class="modal-title" id="tplTitle">Vorlagen</h2>
            <button id="tplClose" class="btn btn-icon modal-close" aria-label="Schlie√üen">‚úï</button>
        </header>
        <div class="modal-body" style="display: grid; grid-template-columns: 320px 1fr; gap: var(--spacing-lg);">
            <div class="template-sidebar">
                <input id="tplSearch" type="text" class="form-input" placeholder="Vorlagen suchen..." style="margin-bottom: var(--spacing-md);">
                <div class="templates-list" id="tplList" style="max-height: 60vh; overflow-y: auto;"></div>
            </div>
            <div class="template-details" id="tplDetails">
                <div class="placeholder">
                    <div class="placeholder-icon">üìù</div>
                    <div class="placeholder-title">Vorlage ausw√§hlen</div>
                    <div class="placeholder-text">W√§hle eine Vorlage aus der Liste, um Details anzuzeigen.</div>
                </div>
            </div>
        </div>
    </div>
</dialog>

<script>
(function(){
  // CONFIG & HELPERS (bleiben gr√∂√ütenteils unver√§ndert)
  const API_BASE = localStorage.getItem('chronos_api') || '/api/v1';
  const API_KEY  = localStorage.getItem('chronos_api_key') || '';
  const DEFAULT_CAL = localStorage.getItem('chronos_calendar') || 'primary';
  const TZ = 'Europe/Berlin';

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const escapeHtml = (s='') => s.replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const debounce = (fn, ms=300) => {
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  };
  const fmtDateTime = (isoUtc) => {
    if (!isoUtc) return '';
    try{
      return new Date(isoUtc).toLocaleString('de-DE', { timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }catch{ return isoUtc }
  };

  // STATE
  const state = {
    range: '7', direction: 'future', q:'', page:1, pageSize:100,
    events: [], templates: [], selectedTemplate: null
  };

  // API (unver√§ndert)
  async function api(path, {method='GET', params=null, body=null}={}){
    const url = new URL(API_BASE + path, window.location.origin);
    if (params) Object.entries(params).forEach(([k,v])=> (v!==undefined && v!==null && v!=='') && url.searchParams.append(k, v));
    const res = await fetch(url.toString(), {
      method,
      headers: { 'Accept': 'application/json', 'Content-Type': 'application/json', ...(API_KEY ? {'X-API-Key': API_KEY} : {}) },
      body: body ? JSON.stringify(body) : null
    });
    if (!res.ok) { const txt=await res.text().catch(()=>''); throw new Error(`API-Fehler ${res.status}: ${txt}`); }
    return res.json();
  }

  // LOGIC
  async function fetchEvents(){
    $('#list').setAttribute('aria-busy','true');
    $('#status').textContent = 'Lade Events...';
    try{
      const data = await api('/events', { params: {
        calendar: DEFAULT_CAL,
        range: state.range,
        direction: (state.range === '-1') ? 'all' : state.direction,
        q: state.q,
        page: state.page,
        page_size: state.pageSize
      }});
      state.events = data.items || [];
      renderEvents();
      $('#status').textContent = `${state.events.length} Eintr√§ge geladen`;
      $('#kpi-count').textContent = String(state.events.length);
    }catch(err){
      $('#status').textContent = String(err.message||err);
      $('#list').innerHTML = `<div class="placeholder"><div class="placeholder-icon">‚ö†Ô∏è</div><div class="placeholder-title">Fehler beim Laden</div><div class="placeholder-text">${escapeHtml(String(err.message||err))}</div><button id="retry" class="btn btn-secondary">Erneut versuchen</button></div>`;
      $('#retry')?.addEventListener('click', fetchEvents);
    }finally{ $('#list').setAttribute('aria-busy','false'); }
  }

  async function searchTemplates(q){
    const listEl = $('#tplList'); listEl.setAttribute('aria-busy','true');
    try{
      const data = await api('/templates', { params: { q, page:1, page_size:100 } });
      state.templates = data.items || [];
      renderTemplates(q);
    }catch(err){
      listEl.innerHTML = `<div class="placeholder-text">${escapeHtml(String(err.message||err))}</div>`;
    }finally{ listEl.setAttribute('aria-busy','false'); }
  }
  
  async function useTemplate(id){
    try{ await api(`/templates/${id}/use`, { method:'POST' }); }
    catch(e){ console.warn('useTemplate fehlgeschlagen:', e); }
  }

  // RENDER
  function renderEvents(){
    const listEl = $('#list');
    listEl.innerHTML = '';
    if (!state.events.length){
      listEl.innerHTML = `<div class="placeholder"><div class="placeholder-icon">üì≠</div><div class="placeholder-title">Keine Eintr√§ge gefunden</div><div class="placeholder-text">√Ñndere die Filter oder erstelle neue Events.</div></div>`;
      return;
    }
    const frag = document.createDocumentFragment();
    for (const ev of state.events){
      const item = document.createElement('div');
      item.className = 'list-item';
      const isAllDay = !!ev.all_day;
      const when = isAllDay ? ev.all_day_date : `${fmtDateTime(ev.start_utc)} - ${fmtDateTime(ev.end_utc)}`;
      item.innerHTML = `
        <div class="list-item-info">
            <h4 class="list-item-title">${escapeHtml(ev.title || '(ohne Titel)')}</h4>
            <p class="list-item-meta">${escapeHtml(ev.description||'')}</p>
            <p class="list-item-meta muted">${when}</p>
        </div>
        <div class="list-item-actions">
            <span class="badge">${isAllDay ? 'Ganzt√§gig' : 'Zeitgebunden'}</span>
        </div>
      `;
      frag.appendChild(item);
    }
    listEl.appendChild(frag);
  }
  
  function renderTemplates(q=''){
    const listEl = $('#tplList'); listEl.innerHTML='';
    if (!state.templates.length){ listEl.innerHTML = `<div class="placeholder-text">Keine Vorlagen gefunden.</div>`; return; }
    const frag = document.createDocumentFragment();
    state.templates.forEach(t => {
      const item = document.createElement('div');
      item.className='template-list-item';
      item.setAttribute('data-id', t.id);
      item.innerHTML = `
        <h4 class="list-item-title">${escapeHtml(t.title)}</h4>
        <p class="list-item-meta muted">${escapeHtml(t.description||'')}</p>
      `;
      item.addEventListener('click', ()=> selectTemplate(t));
      frag.appendChild(item);
    });
    listEl.appendChild(frag);
  }

  function selectTemplate(t){
    state.selectedTemplate = t;
    $('#tplDetails').innerHTML = `
        <h3 class="modal-subtitle">${escapeHtml(t.title)}</h3>
        <p>${escapeHtml(t.description||'')}</p>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Typ</span>
                <span class="info-value">${t.all_day ? 'Ganzt√§gig' : `Default-Zeit: ${escapeHtml(t.default_time||'‚Äî')}`}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Dauer</span>
                <span class="info-value">${t.duration_minutes||'‚Äî'} Minuten</span>
            </div>
            <div class="info-item">
                <span class="info-label">Tags</span>
                <span class="info-value">${(t.tags||[]).map(escapeHtml).join(', ') || '‚Äî'}</span>
            </div>
             <div class="info-item">
                <span class="info-label">Verwendet</span>
                <span class="info-value">${t.usage_count ?? 0} mal</span>
            </div>
        </div>
        <div class="form-actions" style="margin-top: auto;">
            <button id="tplApply" class="btn btn-primary">Vorlage verwenden</button>
        </div>
    `;
    $('#tplApply').addEventListener('click', async ()=>{
      await useTemplate(t.id);
      closeTemplates();
      fetchEvents();
    });
  }

  // MODAL
  const dlg = $('#tplDialog');
  function openTemplates(){
    dlg.showModal();
    searchTemplates('');
    $('#tplSearch').focus();
  }
  function closeTemplates(){
    if (dlg.open) dlg.close();
  }

  // INIT
  function init(){
    const debouncedFetch = debounce(fetchEvents, 300);
    
    $('#range-select').addEventListener('change', (e)=>{ state.range = e.target.value; debouncedFetch(); });
    $$('input[name="direction"]').forEach(r => r.addEventListener('change', (e)=>{ state.direction = e.target.value; debouncedFetch(); }));
    $('#search-input').addEventListener('input', debounce((e)=>{ state.q = e.target.value; fetchEvents(); }, 300));
    
    $('#btn-templates').addEventListener('click', openTemplates);
    $('#tplClose').addEventListener('click', closeTemplates);
    dlg.querySelector('.modal-backdrop').addEventListener('click', closeTemplates);
    $('#tplSearch').addEventListener('input', debounce((e)=> searchTemplates(e.target.value), 300));

    fetchEvents();
  }

  window.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>