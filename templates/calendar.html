{% extends "base.html" %}

{% block title %}Kalender - Chronos Engine{% endblock %}

{% block page_title %}Kalender{% endblock %}
{% block page_subtitle %}Verwalte deine Events und Termine{% endblock %}

{% block header_actions %}
<button class="btn btn-secondary" onclick="refreshCalendar()" aria-label="Kalender aktualisieren">
    <span aria-hidden="true">üîÑ</span>
    Aktualisieren
</button>
<button class="btn btn-primary" onclick="createNewEvent()" aria-label="Neues Event erstellen">
    <span aria-hidden="true">‚ûï</span>
    Neues Event
</button>
{% endblock %}

{% block content %}
<div class="calendar-layout animate-fade-in">
    <!-- Calendar Controls -->
    <section class="calendar-controls" aria-labelledby="calendar-controls-heading">
        <h2 id="calendar-controls-heading" class="sr-only">Kalender Navigation</h2>
        <div class="controls-row">
            <div class="view-controls">
                <button class="btn btn-secondary active" onclick="switchView('month')" aria-pressed="true">Monat</button>
                <button class="btn btn-secondary" onclick="switchView('week')" aria-pressed="false">Woche</button>
                <button class="btn btn-secondary" onclick="switchView('day')" aria-pressed="false">Tag</button>
            </div>

            <div class="date-navigation">
                <button class="btn btn-secondary" onclick="navigateCalendar(-1)" aria-label="Vorheriger Monat">
                    <span aria-hidden="true">‚Äπ</span>
                </button>
                <h2 id="currentMonth" class="current-period">Dezember 2024</h2>
                <button class="btn btn-secondary" onclick="navigateCalendar(1)" aria-label="N√§chster Monat">
                    <span aria-hidden="true">‚Ä∫</span>
                </button>
            </div>

            <button class="btn btn-secondary" onclick="goToToday()">Heute</button>
        </div>
    </section>

    <!-- Main Calendar Grid -->
    <div class="calendar-main">
        <!-- Calendar Grid -->
        <section class="calendar-view" aria-labelledby="calendar-view-heading">
            <h2 id="calendar-view-heading" class="sr-only">Kalender Ansicht</h2>

            <!-- Calendar Header -->
            <div class="calendar-header">
                <div class="weekday">Mo</div>
                <div class="weekday">Di</div>
                <div class="weekday">Mi</div>
                <div class="weekday">Do</div>
                <div class="weekday">Fr</div>
                <div class="weekday">Sa</div>
                <div class="weekday">So</div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid" id="calendarGrid" role="grid" aria-label="Kalender Grid">
                <!-- Dynamic calendar days will be inserted here -->
            </div>
        </section>

        <!-- Sidebar -->
        <aside class="calendar-sidebar">
            <!-- Today's Events -->
            <div class="today-events card">
                <h3>Heute</h3>
                <div class="day-events" id="todayEvents">
                    <div class="loading-events" id="todayEventsLoading">
                        <div class="spinner" style="width: 20px; height: 20px;"></div>
                        <span>Events werden geladen...</span>
                    </div>
                </div>

                <button class="btn btn-secondary btn-sm" onclick="viewAllDayEvents()" style="margin-top: var(--space-4); width: 100%;">
                    Alle Events anzeigen
                </button>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats card">
                <h3>Statistiken</h3>
                <div class="stat-item">
                    <span class="stat-label">Events heute:</span>
                    <span class="stat-value" id="todayEventsCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Diese Woche:</span>
                    <span class="stat-value" id="weekEventsCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Kommende Deadlines:</span>
                    <span class="stat-value" id="upcomingDeadlines">0</span>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Floating Action Button -->
<button class="fab" onclick="createNewEvent()" aria-label="Neues Event erstellen">
    <span aria-hidden="true">‚ûï</span>
</button>
{% endblock %}

{% block extra_scripts %}
<script>
    // Calendar-specific JavaScript
    let currentDate = new Date();
    let currentView = 'month';

    // Initialize calendar on page load
    document.addEventListener('DOMContentLoaded', function() {
        generateCalendar();
        loadTodayEvents();
    });

    function generateCalendar() {
        const grid = document.getElementById('calendarGrid');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Update header
        document.getElementById('currentMonth').textContent =
            new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' }).format(currentDate);

        // Clear existing calendar
        grid.innerHTML = '';

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay() + 1); // Start from Monday

        // Generate 6 weeks (42 days)
        for (let i = 0; i < 42; i++) {
            const dayDate = new Date(startDate);
            dayDate.setDate(startDate.getDate() + i);

            const dayElement = document.createElement('button');
            dayElement.className = 'calendar-day';
            dayElement.setAttribute('data-date', dayDate.toISOString().split('T')[0]);

            // Check if day is in current month
            if (dayDate.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }

            // Check if today
            const today = new Date();
            if (dayDate.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }

            // Load events for this day from API
            loadDayEvents(dayDate, dayElement);

            dayElement.innerHTML = `
                <span class="day-number">${dayDate.getDate()}</span>
            `;

            dayElement.addEventListener('click', () => selectDay(dayDate));
            grid.appendChild(dayElement);
        }
    }

    function navigateCalendar(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        generateCalendar();
    }

    function goToToday() {
        currentDate = new Date();
        generateCalendar();
    }

    function switchView(view) {
        currentView = view;

        // Update button states
        document.querySelectorAll('.view-controls .btn').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
        });
        event.target.classList.add('active');
        event.target.setAttribute('aria-pressed', 'true');

        // TODO: Implement different calendar views
        showToast('Ansicht gewechselt', `${view} Ansicht aktiviert`, 'info');
    }

    function selectDay(date) {
        // Remove previous selection
        document.querySelectorAll('.calendar-day.selected').forEach(day => {
            day.classList.remove('selected');
        });

        // Add selection to clicked day
        event.target.classList.add('selected');

        // Load events for selected day
        loadDayEvents(date);
    }

    async function loadDayEvents(date, dayElement = null) {
        try {
            const dateString = date.toISOString().split('T')[0];
            const response = await fetch(`/api/v1/events?date=${dateString}`, {
                headers: {
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                }
            });

            if (response.ok) {
                const events = await response.json();
                if (dayElement && events.length > 0) {
                    dayElement.classList.add('has-events');
                }
                return events;
            }
        } catch (error) {
            console.error('Fehler beim Laden der Events f√ºr', date, error);
        }
        return [];
    }

    async function loadTodayEvents() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const response = await fetch(`/api/v1/events?date=${today}`, {
                headers: {
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const events = await response.json();
            displayTodayEvents(events);
            updateStatistics(events);

        } catch (error) {
            console.error('Fehler beim Laden der heutigen Events:', error);
            document.getElementById('todayEventsLoading').innerHTML =
                '<p style="color: var(--text-muted); text-align: center;">Keine Events f√ºr heute gefunden</p>';
        }
    }

    function displayTodayEvents(events) {
        const eventsContainer = document.getElementById('todayEvents');
        const loading = document.getElementById('todayEventsLoading');

        if (loading) {
            loading.remove();
        }

        if (!events || events.length === 0) {
            eventsContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Keine Events f√ºr heute</p>';
            return;
        }

        eventsContainer.innerHTML = events.map(event => {
            const startTime = new Date(event.start_time).toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <div class="day-event" onclick="viewEventDetails('${event.id}')">
                    <time class="event-time" datetime="${event.start_time}">${startTime}</time>
                    <div class="event-info">
                        <h4 class="event-title">${event.summary || event.title}</h4>
                        <div class="priority-label ${event.priority || 'medium'}">${
                            event.priority === 'high' ? 'Hoch' :
                            event.priority === 'low' ? 'Niedrig' : 'Mittel'
                        }</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function updateStatistics(todayEvents = null) {
        try {
            // Events heute
            if (todayEvents) {
                document.getElementById('todayEventsCount').textContent = todayEvents.length;
            }

            // Events diese Woche
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1); // Montag
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6); // Sonntag

            const weekResponse = await fetch(`/api/v1/events?start=${weekStart.toISOString().split('T')[0]}&end=${weekEnd.toISOString().split('T')[0]}`, {
                headers: {
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                }
            });

            if (weekResponse.ok) {
                const weekEvents = await weekResponse.json();
                document.getElementById('weekEventsCount').textContent = weekEvents.length || 0;
            }

            // Kommende Deadlines (Events mit hoher Priorit√§t in den n√§chsten 7 Tagen)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);

            const deadlinesResponse = await fetch(`/api/v1/events?start=${new Date().toISOString().split('T')[0]}&end=${nextWeek.toISOString().split('T')[0]}&priority=high`, {
                headers: {
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                }
            });

            if (deadlinesResponse.ok) {
                const deadlines = await deadlinesResponse.json();
                document.getElementById('upcomingDeadlines').textContent = deadlines.length || 0;
            }

        } catch (error) {
            console.error('Fehler beim Laden der Statistiken:', error);
        }
    }

    function refreshCalendar() {
        showToast('Kalender aktualisiert', 'Alle Events wurden neu geladen', 'success');
        generateCalendar();
        loadTodayEvents();
    }

    function createNewEvent() {
        showModal('event-modal', 'Neues Event erstellen', `
            <form id="eventForm">
                <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                    <div>
                        <label for="eventTitle" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Titel</label>
                        <input type="text" id="eventTitle" name="title" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);" required>
                    </div>
                    <div>
                        <label for="eventDate" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Datum</label>
                        <input type="date" id="eventDate" name="date" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                        <div>
                            <label for="eventStartTime" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Startzeit</label>
                            <input type="time" id="eventStartTime" name="startTime" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);" required>
                        </div>
                        <div>
                            <label for="eventEndTime" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Endzeit</label>
                            <input type="time" id="eventEndTime" name="endTime" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);" required>
                        </div>
                    </div>
                    <div>
                        <label for="eventPriority" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Priorit√§t</label>
                        <select id="eventPriority" name="priority" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);">
                            <option value="low">Niedrig</option>
                            <option value="medium" selected>Mittel</option>
                            <option value="high">Hoch</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventDescription" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Beschreibung</label>
                        <textarea id="eventDescription" name="description" rows="3" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md); resize: vertical;"></textarea>
                    </div>
                </div>
            </form>
        `, [
            { text: 'Abbrechen', action: 'closeModal', class: 'btn-secondary' },
            { text: 'Event erstellen', action: 'createEvent', class: 'btn-primary' }
        ]);
    }

    async function createEvent() {
        const form = document.getElementById('eventForm');
        const formData = new FormData(form);

        const eventData = {
            title: formData.get('title'),
            start_time: `${formData.get('date')}T${formData.get('startTime')}:00`,
            end_time: formData.get('endTime') ? `${formData.get('date')}T${formData.get('endTime')}:00` : null,
            priority: formData.get('priority'),
            description: formData.get('description') || ''
        };

        try {
            const response = await fetch('/api/v1/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                },
                body: JSON.stringify(eventData)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            showToast('Event erstellt', `"${eventData.title}" wurde erfolgreich erstellt`, 'success');
            closeModal();

            // Refresh calendar to show new event
            generateCalendar();
            loadTodayEvents();

        } catch (error) {
            console.error('Fehler beim Erstellen des Events:', error);
            showToast('Fehler', 'Event konnte nicht erstellt werden: ' + error.message, 'error');
        }
    }

    async function viewAllDayEvents() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const response = await fetch(`/api/v1/events?date=${today}`, {
                headers: {
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const events = await response.json();

            if (!events || events.length === 0) {
                showModal('day-events-modal', 'Alle Events von heute', `
                    <p style="color: var(--text-muted); text-align: center; padding: var(--space-8);">
                        Keine Events f√ºr heute gefunden
                    </p>
                `, [
                    { text: 'Schlie√üen', action: 'closeModal', class: 'btn-primary' }
                ]);
                return;
            }

            const eventsHtml = events.map(event => {
                const startTime = new Date(event.start_time).toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const endTime = event.end_time ? new Date(event.end_time).toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : null;

                const timeRange = endTime ? `${startTime} - ${endTime}` : startTime;

                return `
                    <div class="day-event" onclick="viewEventDetails('${event.id}'); closeModal();">
                        <time class="event-time" datetime="${event.start_time}">${timeRange}</time>
                        <div class="event-info">
                            <h4 class="event-title">${event.summary || event.title}</h4>
                            ${event.description ? `<p>${event.description}</p>` : ''}
                            <div class="priority-label ${event.priority || 'medium'}">${
                                event.priority === 'high' ? 'Hoch' :
                                event.priority === 'low' ? 'Niedrig' : 'Mittel'
                            }</div>
                        </div>
                    </div>
                `;
            }).join('');

            showModal('day-events-modal', `Alle Events von heute (${events.length})`, `
                <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                    ${eventsHtml}
                </div>
            `, [
                { text: 'Schlie√üen', action: 'closeModal', class: 'btn-primary' }
            ]);

        } catch (error) {
            console.error('Fehler beim Laden aller Events:', error);
            showModal('day-events-modal', 'Fehler', `
                <p style="color: var(--danger-600); text-align: center; padding: var(--space-8);">
                    Events konnten nicht geladen werden: ${error.message}
                </p>
            `, [
                { text: 'Schlie√üen', action: 'closeModal', class: 'btn-primary' }
            ]);
        }
    }
</script>

<style>
/* Calendar-specific styles */
.calendar-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    padding: var(--space-6);
}

.calendar-controls .controls-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-4);
    flex-wrap: wrap;
}

.view-controls {
    display: flex;
    gap: var(--space-2);
}

.date-navigation {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

.current-period {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin: 0;
    min-width: 200px;
    text-align: center;
}

.calendar-main {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: var(--space-6);
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    margin-bottom: var(--space-4);
}

.weekday {
    padding: var(--space-3);
    text-align: center;
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    background: var(--surface-secondary);
    border-radius: var(--radius-sm);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--border-subtle);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.calendar-day {
    aspect-ratio: 1;
    padding: var(--space-3);
    background: var(--surface-primary);
    position: relative;
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    min-height: 100px;
    border: none;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
}

.calendar-day:hover {
    background: var(--state-hover);
    z-index: 1;
    box-shadow: var(--shadow-sm);
}

.calendar-day.selected {
    background: var(--state-selected);
    border: 2px solid var(--primary-500);
}

.calendar-day.today {
    background: var(--primary-50);
    font-weight: var(--font-weight-semibold);
}

.calendar-day.other-month {
    color: var(--text-muted);
    background: var(--surface-tertiary);
}

.calendar-day.has-events::after {
    content: '';
    position: absolute;
    bottom: var(--space-2);
    right: var(--space-2);
    width: 6px;
    height: 6px;
    background: var(--primary-500);
    border-radius: var(--radius-full);
}

.day-number {
    font-weight: var(--font-weight-medium);
}

.calendar-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.day-event {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-3);
    border-left: 3px solid var(--primary-500);
    background: var(--surface-secondary);
    border-radius: var(--radius-sm);
}

.event-time {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    font-weight: var(--font-weight-medium);
    white-space: nowrap;
}

.event-info {
    flex: 1;
}

.event-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin: 0 0 var(--space-1) 0;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--border-subtle);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.stat-value {
    font-weight: var(--font-weight-semibold);
    color: var(--primary-600);
}

@media (max-width: 768px) {
    .calendar-main {
        grid-template-columns: 1fr;
    }

    .controls-row {
        flex-direction: column;
        align-items: stretch;
    }

    .calendar-day {
        min-height: 60px;
        font-size: var(--font-size-xs);
    }
}
</style>
{% endblock %}