<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Chronos Engine</title>

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Premium CSS -->
    <link rel="stylesheet" href="/static/css/chronos-premium.css">
</head>
<body>
    <!-- Skip Link f√ºr Barrierefreiheit -->
    <a href="#main-content" class="skip-link">Zum Hauptinhalt springen</a>

    <div class="app-container">
        <!-- Sidebar Overlay f√ºr Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar" role="navigation" aria-label="Hauptnavigation">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <div class="logo-icon" aria-hidden="true">‚è∞</div>
                    <span class="logo-text">Chronos</span>
                </a>
            </div>

            <div class="sidebar-nav">
                <a href="/dashboard" class="nav-item active" aria-current="page">
                    <div class="nav-item-indicator"></div>
                    <span class="nav-icon" role="img" aria-label="Dashboard">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/calendar" class="nav-item">
                    <div class="nav-item-indicator"></div>
                    <span class="nav-icon" role="img" aria-label="Kalender">üìÖ</span>
                    <span>Kalender</span>
                </a>
                <a href="/events" class="nav-item">
                    <div class="nav-item-indicator"></div>
                    <span class="nav-icon" role="img" aria-label="Events">üìã</span>
                    <span>Events</span>
                </a>
                <a href="/analytics" class="nav-item">
                    <div class="nav-item-indicator"></div>
                    <span class="nav-icon" role="img" aria-label="Analytics">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="/settings" class="nav-item">
                    <div class="nav-item-indicator"></div>
                    <span class="nav-icon" role="img" aria-label="Einstellungen">‚öôÔ∏è</span>
                    <span>Einstellungen</span>
                </a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content" id="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="header-title">
                        <h1>Dashboard</h1>
                        <p class="header-subtitle">Willkommen zur√ºck! Hier ist deine √úbersicht f√ºr heute.</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="toggleSidebar()" aria-label="Seitenleiste umschalten">
                            <span aria-hidden="true">‚ò∞</span>
                        </button>
                        <button class="btn btn-secondary" onclick="refreshDashboard()" aria-label="Dashboard aktualisieren">
                            <span aria-hidden="true">üîÑ</span>
                            Aktualisieren
                        </button>
                        <button class="btn btn-primary" onclick="syncCalendar()" aria-label="Kalendersynchronisation starten">
                            <span aria-hidden="true">‚ö°</span>
                            Sync starten
                        </button>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content animate-fade-in">
                <!-- Stats Grid -->
                <section aria-labelledby="stats-heading">
                    <h2 id="stats-heading" class="sr-only">Leistungsmetriken</h2>
                    <div class="stats-grid animate-stagger">
                        <article class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Gesamte Events</span>
                                <div class="metric-icon" aria-hidden="true">üìÖ</div>
                            </div>
                            <div class="metric-value" id="totalEvents">{{ productivity_metrics.total_events or 127 }}</div>
                            <div class="metric-change positive" id="eventsChange">
                                <span aria-label="Anstieg">‚Üó</span>
                                <span>+18% diese Woche</span>
                            </div>
                        </article>

                        <article class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Produktivit√§tsrate</span>
                                <div class="metric-icon" aria-hidden="true">üéØ</div>
                            </div>
                            <div class="metric-value" id="productivityRate">{{ "%.1f" | format((productivity_metrics.completion_rate or 0.873) * 100) }}%</div>
                            <div class="metric-change positive" id="productivityChange">
                                <span aria-label="Anstieg">‚Üó</span>
                                <span>+5.2% vs. letzten Monat</span>
                            </div>
                        </article>

                        <article class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Focus Time</span>
                                <div class="metric-icon" aria-hidden="true">‚è±Ô∏è</div>
                            </div>
                            <div class="metric-value" id="timeSaved">{{ "%.1f" | format(productivity_metrics.total_hours or 4.5) }}h</div>
                            <div class="metric-change positive" id="timeSavedChange">
                                <span aria-label="Anstieg">‚Üó</span>
                                <span>+30min heute</span>
                            </div>
                        </article>

                        <article class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Abgeschlossene Tasks</span>
                                <div class="metric-icon" aria-hidden="true">‚úÖ</div>
                            </div>
                            <div class="metric-value" id="completedTasks">{{ productivity_metrics.completed_tasks or 42 }}</div>
                            <div class="metric-change negative" id="tasksChange">
                                <span aria-label="R√ºckgang">‚Üì</span>
                                <span>-3 vs. gestern</span>
                            </div>
                        </article>

                        <article class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Sync Status</span>
                                <div class="metric-icon" aria-hidden="true">üîÑ</div>
                            </div>
                            <div class="metric-value" style="font-size: 18px;" id="syncStatus">
                                <span class="status-indicator active" aria-hidden="true"></span>
                                Verbunden
                            </div>
                            <div class="metric-change neutral" id="lastUpdate">
                                vor 3 Min
                            </div>
                        </article>

                        <article class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">CalDAV Events</span>
                                <div class="metric-icon" aria-hidden="true">üìä</div>
                            </div>
                            <div class="metric-value" id="caldavEvents">{{ caldav_events or 98 }}</div>
                            <div class="metric-change positive" id="caldavChange">
                                <span aria-label="Anstieg">‚Üó</span>
                                <span>+7 neue Events</span>
                            </div>
                        </article>
                    </div>
                </section>

                <!-- Charts Section -->
                <section aria-labelledby="charts-heading">
                    <h2 id="charts-heading" class="sr-only">Diagramme</h2>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Wochen√ºbersicht</h3>
                                    <p class="chart-subtitle">Produktivit√§t der letzten 7 Tage</p>
                                </div>
                            </div>
                            <div class="chart-placeholder" role="img" aria-label="S√§ulendiagramm der Wochenproduktivit√§t">
                                <div class="chart-bar" style="height: 60%"></div>
                                <div class="chart-bar" style="height: 80%"></div>
                                <div class="chart-bar" style="height: 70%"></div>
                                <div class="chart-bar" style="height: 90%"></div>
                                <div class="chart-bar" style="height: 85%"></div>
                                <div class="chart-bar" style="height: 95%"></div>
                                <div class="chart-bar" style="height: 75%"></div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Priorit√§tsverteilung</h3>
                                    <p class="chart-subtitle">Aktuelle Events</p>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <div style="width: 100%; height: 32px; background: linear-gradient(90deg, var(--danger-500) 25%, var(--border-subtle) 25%); border-radius: var(--radius-full);"></div>
                                    <span style="white-space: nowrap; font-size: var(--font-size-sm);">Hoch (25%)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <div style="width: 100%; height: 32px; background: linear-gradient(90deg, var(--warning-400) 45%, var(--border-subtle) 45%); border-radius: var(--radius-full);"></div>
                                    <span style="white-space: nowrap; font-size: var(--font-size-sm);">Mittel (45%)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <div style="width: 100%; height: 32px; background: linear-gradient(90deg, var(--success-500) 30%, var(--border-subtle) 30%); border-radius: var(--radius-full);"></div>
                                    <span style="white-space: nowrap; font-size: var(--font-size-sm);">Niedrig (30%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Recent Events Section -->
                <section class="events-section" aria-labelledby="events-heading">
                    <div class="section-header">
                        <h2 id="events-heading" class="chart-title">Heutige Events</h2>
                        <button class="btn btn-secondary">Alle anzeigen</button>
                    </div>

                    <div class="event-list">
                        <article class="event-item">
                            <time class="event-time" datetime="09:00">09:00</time>
                            <div class="event-details">
                                <h3>Team Standup</h3>
                                <p class="event-meta">T√§gliches Sync-Meeting ‚Ä¢ 15 Minuten</p>
                            </div>
                            <div class="priority-label low">
                                <span class="sr-only">Niedrige Priorit√§t</span>
                                Niedrig
                            </div>
                        </article>

                        <article class="event-item">
                            <time class="event-time" datetime="10:30">10:30</time>
                            <div class="event-details">
                                <h3>Client Pr√§sentation</h3>
                                <p class="event-meta">Projekt Review ‚Ä¢ 90 Minuten</p>
                            </div>
                            <div class="priority-label high">
                                <span class="sr-only">Hohe Priorit√§t</span>
                                Hoch
                            </div>
                        </article>

                        <article class="event-item">
                            <time class="event-time" datetime="14:00">14:00</time>
                            <div class="event-details">
                                <h3>Sprint Planning</h3>
                                <p class="event-meta">Zweiw√∂chentliche Planung ‚Ä¢ 2 Stunden</p>
                            </div>
                            <div class="priority-label medium">
                                <span class="sr-only">Mittlere Priorit√§t</span>
                                Mittel
                            </div>
                        </article>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="createNewEvent()" aria-label="Neues Event erstellen">
        <span aria-hidden="true">‚ûï</span>
    </button>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer" role="region" aria-live="polite" aria-label="Benachrichtigungen"></div>

    <!-- Loading Overlay -->
    <div class="modal-overlay" id="loadingOverlay" style="display: none;" aria-hidden="true">
        <div class="spinner"></div>
    </div>

    <!-- JavaScript -->
    <script>
        // Globale Variablen
        let sidebarOpen = false;
        let currentTheme = localStorage.getItem('theme') || 'auto';

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadDashboardData();
            setupEventListeners();
        });

        // App Initialization
        function initializeApp() {
            loadSidebarState();
            applyTheme();

            // ARIA-Unterst√ºtzung f√ºr Toast-Container
            const toastContainer = document.getElementById('toastContainer');
            if (toastContainer) {
                toastContainer.setAttribute('aria-live', 'polite');
                toastContainer.setAttribute('aria-atomic', 'true');
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Keyboard Navigation
            document.addEventListener('keydown', handleKeyboardNavigation);

            // Escape key f√ºr Modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSidebar();
                }
            });

            // Responsive Sidebar
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768 && sidebarOpen) {
                    closeSidebar();
                }
            });
        }

        // Keyboard Navigation
        function handleKeyboardNavigation(e) {
            // Alt + M: Toggle Sidebar
            if (e.altKey && e.key === 'm') {
                e.preventDefault();
                toggleSidebar();
            }

            // Alt + R: Refresh Dashboard
            if (e.altKey && e.key === 'r') {
                e.preventDefault();
                refreshDashboard();
            }

            // Alt + S: Sync Calendar
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                syncCalendar();
            }
        }

        // Sidebar Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebarOpen = !sidebarOpen;
                sidebar.classList.toggle('open', sidebarOpen);
                overlay.classList.toggle('open', sidebarOpen);

                // ARIA
                sidebar.setAttribute('aria-hidden', !sidebarOpen);

                // Focus Management
                if (sidebarOpen) {
                    sidebar.querySelector('.nav-item').focus();
                }
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebarOpen = false;
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            sidebar.setAttribute('aria-hidden', 'true');
        }

        function loadSidebarState() {
            // Load nur f√ºr Desktop relevant
            if (window.innerWidth > 768) {
                const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                if (isCollapsed) {
                    document.querySelector('.app-container').classList.add('sidebar-collapsed');
                }
            }
        }

        // Theme Functions
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'auto';
            document.documentElement.setAttribute('data-theme', theme);
        }

        // Dashboard Functions
        async function refreshDashboard() {
            showLoading();
            try {
                await loadDashboardData();
                showToast('Dashboard aktualisiert', 'Alle Daten wurden erfolgreich geladen', 'success');
            } catch (error) {
                showToast('Fehler', 'Dashboard konnte nicht aktualisiert werden', 'error');
            } finally {
                hideLoading();
            }
        }

        async function syncCalendar() {
            showToast('Synchronisation gestartet', 'Kalender wird synchronisiert...', 'info');

            try {
                const response = await fetch('/api/v1/sync/incremental', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': 'super-secret-change-me',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                showToast('Sync erfolgreich', data.message || 'Kalender wurde erfolgreich synchronisiert', 'success');
                await refreshDashboard();

            } catch (error) {
                console.error('Sync error:', error);
                showToast('Sync Fehler', 'Synchronisation fehlgeschlagen: ' + error.message, 'error');
            }
        }

        async function triggerFullSync() {
            showLoading();
            try {
                const response = await fetch('/api/v1/sync/full', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': 'super-secret-change-me',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                showToast('Full Sync erfolgreich', data.message || 'Vollst√§ndige Synchronisation abgeschlossen', 'success');
                await refreshDashboard();

            } catch (error) {
                console.error('Full sync error:', error);
                showToast('Sync Fehler', 'Vollst√§ndige Synchronisation fehlgeschlagen: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Data Loading
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard-data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                // Update Metrics
                updateMetrics(data.metrics || {});

                // Update Sync Status
                updateSyncStatus(data.sync_status || {});

            } catch (error) {
                console.error('Fehler beim Laden der Dashboard-Daten:', error);
                // Fallback zu statischen Daten bei Fehler
            }
        }

        function updateMetrics(metrics) {
            const elements = {
                totalEvents: metrics.total_events || 127,
                productivityRate: ((metrics.completion_rate || 0.873) * 100).toFixed(1) + '%',
                timeSaved: (metrics.total_hours || 4.5).toFixed(1) + 'h',
                completedTasks: metrics.completed_tasks || 42,
                caldavEvents: metrics.caldav_events || 98
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        function updateSyncStatus(syncStatus) {
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                lastUpdate.textContent = syncStatus.last_update || 'vor 3 Min';
            }
        }

        // Event Creation
        function createNewEvent() {
            // Hier w√ºrde Modal f√ºr neues Event ge√∂ffnet
            showToast('Neues Event', 'Event-Editor wird ge√∂ffnet...', 'info');
        }

        // Utility Functions
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                overlay.setAttribute('aria-hidden', 'false');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.setAttribute('aria-hidden', 'true');
            }
        }

        // Toast System
        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', 'alert');

            toast.innerHTML = `
                <div class="toast-header">
                    <h4 class="toast-title">${title}</h4>
                    <button class="toast-close" onclick="removeToast(this.parentElement.parentElement)" aria-label="Benachrichtigung schlie√üen">
                        <span aria-hidden="true">√ó</span>
                    </button>
                </div>
                <div class="toast-body">${message}</div>
            `;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Auto-remove nach 8 Sekunden
            setTimeout(() => {
                removeToast(toast);
            }, 8000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            container.setAttribute('role', 'region');
            container.setAttribute('aria-live', 'polite');
            container.setAttribute('aria-label', 'Benachrichtigungen');
            document.body.appendChild(container);
            return container;
        }

        function removeToast(toast) {
            if (toast && toast.parentElement) {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 400);
            }
        }

        // Performance Monitoring (optional)
        if ('performance' in window) {
            window.addEventListener('load', function() {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`Dashboard geladen in ${loadTime}ms`);
            });
        }
    </script>

    <!-- Service Worker Registration (optional) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/js/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registriert:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker Registrierung fehlgeschlagen:', error);
                    });
            });
        }
    </script>
</body>
</html>