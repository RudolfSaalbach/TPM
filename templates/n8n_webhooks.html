{% extends "base.html" %}

{% block title %}n8n Webhook Integration - Chronos Engine{% endblock %}
{% block page_title %}n8n Webhook Integration{% endblock %}
{% block page_subtitle %}Universal Automation Platform für Chronos Engine{% endblock %}

{% block extra_head %}
<style>
    .container {
        max-width: 100%;
        margin: 0;
        padding: 0;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 30px;
        border-radius: var(--border-radius);
        margin-bottom: 30px;
        text-align: center;
    }

    .header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 300;
    }

    .header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }

    .main-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 30px;
        min-height: 600px;
    }

    .sidebar {
        background: white;
        border-radius: var(--border-radius);
        padding: 25px;
        box-shadow: var(--box-shadow);
        height: fit-content;
    }

    .content {
        background: white;
        border-radius: var(--border-radius);
        padding: 25px;
        box-shadow: var(--box-shadow);
    }

    .webhook-card {
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        padding: 20px;
        transition: border-color 0.2s;
    }

    .webhook-card:hover {
        border-color: var(--primary-color);
    }

    .webhook-card.disabled {
        opacity: 0.6;
        background: var(--gray-50);
    }

    .webhook-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .webhook-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--gray-800);
    }

    .webhook-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }

    .webhook-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--gray-200);
    }

    .info-label {
        font-weight: 500;
        color: var(--gray-500);
    }

    .info-value {
        color: var(--gray-800);
        font-family: 'Courier New', monospace;
    }

    .trigger-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 10px 0;
    }

    .trigger-tag {
        background: #e3f2fd;
        color: #1565c0;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .webhook-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--gray-200);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--gray-800);
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--gray-500);
    }

    .spinner {
        border: 3px solid var(--gray-200);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .field-mapping {
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 15px;
        margin-bottom: 15px;
        background: var(--gray-50);
    }

    .field-mapping-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .remove-mapping {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
    }

    .mapping-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    @media (max-width: 768px) {
        .main-layout {
            grid-template-columns: 1fr;
        }

        .mapping-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-section">
    <div class="section-header">
        <h2 class="section-title">🔗 Webhook Konfigurationen</h2>
        <button class="btn btn-primary" onclick="showCreateModal()">
            <span>➕</span>
            Neuer Webhook
        </button>
    </div>

    <div class="main-layout">
        <div class="webhook-sidebar">
            <div class="content-section" style="margin-bottom: var(--spacing-lg);">
                <h4 style="margin-bottom: var(--spacing-md);">Quick Actions</h4>
                <button class="btn btn-secondary" onclick="loadWebhooks()" style="width: 100%; margin-bottom: var(--spacing-sm);">
                    <span>🔄</span>
                    Aktualisieren
                </button>
                <button class="btn btn-secondary" onclick="testAllWebhooks()" style="width: 100%;">
                    <span>🧪</span>
                    Alle Testen
                </button>
            </div>

                <div style="margin-bottom: 30px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Quick Actions</h4>
                    <button class="btn btn-secondary" onclick="loadWebhooks()" style="width: 100%; margin-bottom: 10px;">
                        🔄 Aktualisieren
                    </button>
                    <button class="btn btn-secondary" onclick="testAllWebhooks()" style="width: 100%; margin-bottom: 10px;">
                        🧪 Alle Testen
                    </button>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Trigger Types</h4>
                    <div id="triggerTypes" style="font-size: 0.9rem;">
                        <div class="trigger-tag" style="margin: 5px 0; display: block;">event_created</div>
                        <div class="trigger-tag" style="margin: 5px 0; display: block;">event_updated</div>
                        <div class="trigger-tag" style="margin: 5px 0; display: block;">event_cancelled</div>
                        <div class="trigger-tag" style="margin: 5px 0; display: block;">conflict_detected</div>
                        <div class="trigger-tag" style="margin: 5px 0; display: block;">optimization_suggested</div>
                        <div class="trigger-tag" style="margin: 5px 0; display: block;">daily_summary</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Statistiken</h4>
                    <div class="info-item">
                        <div class="info-label">Aktive Webhooks</div>
                        <div class="info-value" id="activeCount">-</div>
                    </div>
                    <div class="info-item" style="margin-top: 10px;">
                        <div class="info-label">Gesamt Konfigurationen</div>
                        <div class="info-value" id="totalCount">-</div>
                    </div>
                </div>
            </div>

            <div class="content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #2c3e50;">Webhook Konfigurationen</h2>
                    <div>
                        <select id="filterTrigger" class="form-control" style="display: inline-block; width: auto; margin-right: 10px;" onchange="filterWebhooks()">
                            <option value="">Alle Trigger</option>
                        </select>
                        <label>
                            <input type="checkbox" id="filterEnabled" checked onchange="filterWebhooks()"> Nur Aktive
                        </label>
                    </div>
                </div>

                <div id="webhooksList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Lade Webhook Konfigurationen...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="webhookModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Webhook Konfiguration</h3>
            <form id="webhookForm">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="webhook_url">Webhook URL</label>
                    <input type="url" id="webhook_url" name="webhook_url" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="triggers">Trigger Types</label>
                    <select id="triggers" name="triggers" class="form-control" multiple required>
                        <option value="event_created">Event Created</option>
                        <option value="event_updated">Event Updated</option>
                        <option value="event_cancelled">Event Cancelled</option>
                        <option value="event_completed">Event Completed</option>
                        <option value="event_reminder">Event Reminder</option>
                        <option value="conflict_detected">Conflict Detected</option>
                        <option value="optimization_suggested">Optimization Suggested</option>
                        <option value="daily_summary">Daily Summary</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="http_method">HTTP Method</label>
                    <select id="http_method" name="http_method" class="form-control">
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enabled" name="enabled" checked>
                        Aktiviert
                    </label>
                </div>

                <h4>Field Mappings</h4>
                <div id="fieldMappings">
                    <!-- Field mappings will be added dynamically -->
                </div>

                <button type="button" class="btn btn-secondary" onclick="addFieldMapping()">
                    ➕ Field Mapping hinzufügen
                </button>

                <div style="margin-top: 30px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let webhooks = [];
        let currentWebhookId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadWebhooks();
            loadTriggerTypes();
        });

        async function loadWebhooks() {
            try {
                const response = await fetch('/api/n8n/webhooks');
                webhooks = await response.json();
                renderWebhooks();
                updateStats();
            } catch (error) {
                console.error('Error loading webhooks:', error);
                showError('Fehler beim Laden der Webhook Konfigurationen');
            }
        }

        function renderWebhooks() {
            const container = document.getElementById('webhooksList');

            if (webhooks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <p>Keine Webhook Konfigurationen gefunden.</p>
                        <button class="btn" onclick="showCreateModal()">Erste Konfiguration erstellen</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = webhooks.map(webhook => `
                <div class="webhook-card ${webhook.enabled ? '' : 'disabled'}">
                    <div class="webhook-header">
                        <div class="webhook-name">${webhook.name}</div>
                        <div class="webhook-status ${webhook.enabled ? 'status-active' : 'status-inactive'}">
                            ${webhook.enabled ? 'Aktiv' : 'Inaktiv'}
                        </div>
                    </div>

                    <div class="webhook-info">
                        <div class="info-item">
                            <div class="info-label">URL:</div>
                            <div class="info-value">${webhook.webhook_url.substring(0, 50)}...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Method:</div>
                            <div class="info-value">${webhook.http_method}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Field Mappings:</div>
                            <div class="info-value">${webhook.field_mappings_count}</div>
                        </div>
                    </div>

                    <div class="trigger-tags">
                        ${webhook.triggers.map(trigger => `<span class="trigger-tag">${trigger}</span>`).join('')}
                    </div>

                    <div class="webhook-actions">
                        <button class="btn btn-secondary" onclick="editWebhook('${webhook.config_id}')">
                            ✏️ Bearbeiten
                        </button>
                        <button class="btn btn-success" onclick="testWebhook('${webhook.config_id}')">
                            🧪 Testen
                        </button>
                        <button class="btn btn-danger" onclick="deleteWebhook('${webhook.config_id}')">
                            🗑️ Löschen
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const activeCount = webhooks.filter(w => w.enabled).length;
            const totalCount = webhooks.length;

            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function showCreateModal() {
            currentWebhookId = null;
            document.getElementById('modalTitle').textContent = 'Neue Webhook Konfiguration';
            document.getElementById('webhookForm').reset();
            document.getElementById('fieldMappings').innerHTML = '';
            document.getElementById('webhookModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('webhookModal').style.display = 'none';
        }

        async function editWebhook(configId) {
            try {
                const response = await fetch(`/api/n8n/webhooks/${configId}`);
                const webhook = await response.json();

                currentWebhookId = configId;
                document.getElementById('modalTitle').textContent = 'Webhook Konfiguration bearbeiten';

                // Fill form with webhook data
                document.getElementById('name').value = webhook.name;
                document.getElementById('webhook_url').value = webhook.webhook_url;
                document.getElementById('http_method').value = webhook.http_method;
                document.getElementById('enabled').checked = webhook.enabled;

                // Set selected triggers
                const triggerSelect = document.getElementById('triggers');
                for (let option of triggerSelect.options) {
                    option.selected = webhook.triggers.includes(option.value);
                }

                // Load field mappings
                const mappingsContainer = document.getElementById('fieldMappings');
                mappingsContainer.innerHTML = '';
                webhook.field_mappings.forEach(mapping => {
                    addFieldMapping(mapping);
                });

                document.getElementById('webhookModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading webhook:', error);
                showError('Fehler beim Laden der Webhook Konfiguration');
            }
        }

        async function deleteWebhook(configId) {
            if (!confirm('Sind Sie sicher, dass Sie diese Webhook Konfiguration löschen möchten?')) {
                return;
            }

            try {
                const response = await fetch(`/api/n8n/webhooks/${configId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccess('Webhook Konfiguration gelöscht');
                    loadWebhooks();
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                console.error('Error deleting webhook:', error);
                showError('Fehler beim Löschen der Webhook Konfiguration');
            }
        }

        async function testWebhook(configId) {
            try {
                const response = await fetch(`/api/n8n/webhooks/${configId}/test`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.test_successful) {
                    showSuccess('Webhook Test erfolgreich!');
                } else {
                    showError(`Webhook Test fehlgeschlagen: ${result.error}`);
                }
            } catch (error) {
                console.error('Error testing webhook:', error);
                showError('Fehler beim Testen des Webhooks');
            }
        }

        function addFieldMapping(mapping = null) {
            const container = document.getElementById('fieldMappings');
            const mappingDiv = document.createElement('div');
            mappingDiv.className = 'field-mapping';

            mappingDiv.innerHTML = `
                <div class="field-mapping-header">
                    <strong>Field Mapping</strong>
                    <button type="button" class="remove-mapping" onclick="this.parentElement.parentElement.remove()">
                        ✕ Entfernen
                    </button>
                </div>

                <div class="mapping-grid">
                    <div class="form-group">
                        <label>Webhook Field</label>
                        <input type="text" name="webhook_field" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>Source Type</label>
                        <select name="source_type" class="form-control" onchange="updateSourceFields(this)">
                            <option value="event">Event</option>
                            <option value="system">System</option>
                            <option value="static">Static</option>
                            <option value="calculated">Calculated</option>
                            <option value="additional">Additional</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Source Field</label>
                        <input type="text" name="source_field" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Data Type</label>
                        <select name="data_type" class="form-control">
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="datetime">DateTime</option>
                            <option value="array">Array</option>
                        </select>
                    </div>
                </div>
            `;

            container.appendChild(mappingDiv);

            // Fill with existing data if provided
            if (mapping) {
                mappingDiv.querySelector('input[name="webhook_field"]').value = mapping.webhook_field;
                mappingDiv.querySelector('select[name="source_type"]').value = mapping.source_type;
                mappingDiv.querySelector('input[name="source_field"]').value = mapping.source_field || '';
                mappingDiv.querySelector('select[name="data_type"]').value = mapping.data_type;
            }
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        // Form submission
        document.getElementById('webhookForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const selectedTriggers = Array.from(document.getElementById('triggers').selectedOptions).map(opt => opt.value);

            // Collect field mappings
            const mappings = [];
            document.querySelectorAll('.field-mapping').forEach(mapping => {
                mappings.push({
                    webhook_field: mapping.querySelector('input[name="webhook_field"]').value,
                    source_type: mapping.querySelector('select[name="source_type"]').value,
                    source_field: mapping.querySelector('input[name="source_field"]').value,
                    data_type: mapping.querySelector('select[name="data_type"]').value
                });
            });

            const data = {
                name: formData.get('name'),
                webhook_url: formData.get('webhook_url'),
                triggers: selectedTriggers,
                http_method: formData.get('http_method'),
                enabled: formData.has('enabled'),
                field_mappings: mappings
            };

            try {
                const url = currentWebhookId ? `/api/n8n/webhooks/${currentWebhookId}` : '/api/n8n/webhooks';
                const method = currentWebhookId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showSuccess(currentWebhookId ? 'Webhook aktualisiert' : 'Webhook erstellt');
                    closeModal();
                    loadWebhooks();
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving webhook:', error);
                showError('Fehler beim Speichern der Webhook Konfiguration');
            }
        });
    </script>
</body>
</html>