{% extends "admin/base.html" %}

{% set is_edit = whitelist is not none %}

{% block title %}{% if is_edit %}Whitelist bearbeiten{% else %}Whitelist anlegen{% endif %} - Chronos Admin{% endblock %}
{% block header_title %}System Whitelists{% endblock %}
{% block header_subtitle %}Granulare Freigaben f&uuml;r externe Systeme definieren{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="/admin">Admin</a>
    <span>/</span>
    <a href="/admin/whitelists">Whitelists</a>
    <span>/</span>
    <span>{% if is_edit %}Bearbeiten{% else %}Neu{% endif %}</span>
</nav>

<div class="page-header">
    <div>
        <h1>{% if is_edit %}Whitelist-Eintrag bearbeiten{% else %}Whitelist-Eintrag anlegen{% endif %}</h1>
        <p>Steuere, welche Aktionen ein externes System ausf&uuml;hren darf und welche Parameter erlaubt sind.</p>
    </div>
    <div class="header-actions">
        <a class="btn btn-secondary" href="/admin/whitelists">Zur&uuml;ck zur &Uuml;bersicht</a>
    </div>
</div>

<div class="form-card">
    <form method="post" class="form-grid" id="whitelistForm">
        <div class="form-field">
            <label for="system_name">Systemname *</label>
            <input type="text" id="system_name" name="system_name" value="{{ whitelist.system_name if whitelist else '' }}" required placeholder="z. B. TELEGRAM, N8N, SMTP">
            <span class="help-text">Eindeutiger Identifikator des Zielsystems (Empfehlung: Gro&szlig;schreibung).</span>
        </div>

        <div class="form-field">
            <label for="action_name">Aktionsname *</label>
            <input type="text" id="action_name" name="action_name" value="{{ whitelist.action_name if whitelist else '' }}" required placeholder="z. B. SEND_MESSAGE, NOTIFY, EXECUTE">
            <span class="help-text">Definiere den konkreten Befehl oder Workflow, der erlaubt werden soll.</span>
        </div>

        <div class="form-field">
            <label for="allowed_params">Erlaubte Parameter (JSON)</label>
            <textarea id="allowed_params" name="allowed_params" placeholder='{"message": "string", "priority": "int", "channels": "list"}'>{{ allowed_params_json if allowed_params_json else '' }}</textarea>
            <span class="help-text">Optionales JSON-Objekt zur Eingrenzung erlaubter Parameter. Leer lassen f&uuml;r keine Einschr&auml;nkungen.</span>
        </div>

        <div class="info-panel" style="margin: 0;">
            <h4>Beispiele f&uuml;r Parameterdefinitionen</h4>
            <pre>{"message": "string", "priority": "int"}</pre>
            <pre>{"recipient": "email", "subject": "string", "html": "string"}</pre>
            <pre>{"webhook_url": "url", "payload": "object"}</pre>
        </div>

        <div class="form-field checkbox-field">
            <input type="checkbox" id="enabled" name="enabled" {% if not whitelist or whitelist.enabled %}checked{% endif %}>
            <label for="enabled">Eintrag aktiv</label>
            <span class="help-text">Deaktivierte Eintr&auml;ge wirken nicht auf eingehende Befehle.</span>
        </div>

        <div class="form-actions">
            <a class="btn btn-secondary" href="/admin/whitelists">Abbrechen</a>
            <button type="submit" class="btn btn-primary">{% if is_edit %}Eintrag aktualisieren{% else %}Eintrag erstellen{% endif %}</button>
        </div>
    </form>
</div>

<div class="info-panel">
    <h4>Parameter-Typ Referenz</h4>
    <ul>
        <li><code>"string"</code> - Textwerte</li>
        <li><code>"int"</code> - Ganzzahlen</li>
        <li><code>"float"</code> - Dezimalzahlen</li>
        <li><code>"bool"</code> - Wahr/Falsch</li>
        <li><code>"email"</code> - E-Mail-Adressen</li>
        <li><code>"url"</code> - URLs</li>
        <li><code>"list"</code> - Listen/Arrays</li>
        <li><code>"object"</code> - JSON-Objekte</li>
    </ul>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    const textarea = document.getElementById('allowed_params');
    if (!textarea) { return; }

    textarea.addEventListener('blur', function() {
        const value = this.value.trim();
        if (!value) {
            this.style.borderColor = '';
            return;
        }
        try {
            JSON.parse(value);
            this.style.borderColor = 'rgba(0, 200, 81, 0.6)';
        } catch (error) {
            this.style.borderColor = 'rgba(255, 71, 87, 0.8)';
            window.alert('Ung&uuml;ltiges JSON-Format. Bitte Syntax pr&uuml;fen.');
        }
    });
})();
</script>
{% endblock %}



