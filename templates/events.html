{% extends "base.html" %}

{% block title %}Events - Chronos Engine{% endblock %}

{% block page_title %}Events{% endblock %}
{% block page_subtitle %}Verwalte und organisiere deine Events{% endblock %}

{% block header_actions %}
<button class="btn btn-secondary" onclick="refreshEvents()" aria-label="Events aktualisieren">
    <span aria-hidden="true">üîÑ</span>
    Aktualisieren
</button>
<button class="btn btn-primary" onclick="createNewEvent()" aria-label="Neues Event erstellen">
    <span aria-hidden="true">‚ûï</span>
    Neues Event
</button>
{% endblock %}

{% block content %}
<div class="events-layout animate-fade-in">
    <!-- Event Statistics -->
    <section class="events-stats" aria-labelledby="stats-heading">
        <h2 id="stats-heading" class="sr-only">Event Statistiken</h2>
        <div class="stats-grid animate-stagger">
            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">üìÖ</div>
                <div class="stat-content">
                    <span class="stat-label">Gesamt Events</span>
                    <span class="stat-number" id="totalEvents">0</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">‚è∞</div>
                <div class="stat-content">
                    <span class="stat-label">Heute</span>
                    <span class="stat-number" id="todayEvents">0</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">üìä</div>
                <div class="stat-content">
                    <span class="stat-label">Diese Woche</span>
                    <span class="stat-number" id="weekEvents">0</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">üî•</div>
                <div class="stat-content">
                    <span class="stat-label">Hohe Priorit√§t</span>
                    <span class="stat-number" id="highPriorityEvents">0</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Event Filters and Search -->
    <section class="events-controls" aria-labelledby="controls-heading">
        <h2 id="controls-heading" class="sr-only">Event Steuerung</h2>
        <div class="controls-row">
            <div class="search-container">
                <input type="text" id="eventSearch" placeholder="Events suchen..."
                       aria-label="Events suchen" onkeyup="filterEvents()">
                <button type="button" aria-label="Suche starten" onclick="filterEvents()">
                    <span aria-hidden="true">üîç</span>
                </button>
            </div>

            <div class="filter-controls">
                <select id="priorityFilter" onchange="filterEvents()" aria-label="Nach Priorit√§t filtern">
                    <option value="">Alle Priorit√§ten</option>
                    <option value="high">Hoch</option>
                    <option value="medium">Mittel</option>
                    <option value="low">Niedrig</option>
                </select>

                <select id="dateFilter" onchange="filterEvents()" aria-label="Nach Datum filtern">
                    <option value="">Alle Zeiten</option>
                    <option value="today">Heute</option>
                    <option value="tomorrow">Morgen</option>
                    <option value="week">Diese Woche</option>
                    <option value="month">Dieser Monat</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Events List -->
    <section class="events-list-section" aria-labelledby="events-heading">
        <h2 id="events-heading" class="sr-only">Event Liste</h2>
        <div class="events-container">
            <div class="loading-events" id="eventsLoading">
                <div class="spinner"></div>
                <span>Events werden geladen...</span>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let allEvents = [];
    let filteredEvents = [];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadEvents();
        loadStatistics();
    });

    async function loadEvents() {
        try {
            const response = await fetch('/api/v1/events', {
                headers: {
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            allEvents = await response.json();
            filteredEvents = [...allEvents];
            displayEvents(filteredEvents);
            updateEventStats();

        } catch (error) {
            console.error('Fehler beim Laden der Events:', error);
            document.getElementById('eventsLoading').innerHTML =
                '<p style="color: var(--danger-600); text-align: center;">Events konnten nicht geladen werden</p>';
        }
    }

    function displayEvents(events) {
        const container = document.querySelector('.events-container');
        const loading = document.getElementById('eventsLoading');

        if (loading) {
            loading.remove();
        }

        if (!events || events.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon" aria-hidden="true">üìÖ</div>
                    <h3>Keine Events gefunden</h3>
                    <p>Erstelle dein erstes Event oder √§ndere die Filtereinstellungen.</p>
                    <button class="btn btn-primary" onclick="createNewEvent()">
                        <span aria-hidden="true">‚ûï</span>
                        Erstes Event erstellen
                    </button>
                </div>
            `;
            return;
        }

        // Sort events by start time
        events.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

        const eventsHtml = events.map(event => {
            const startTime = new Date(event.start_time);
            const endTime = event.end_time ? new Date(event.end_time) : null;

            const dateString = startTime.toLocaleDateString('de-DE', {
                weekday: 'short',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            const timeString = startTime.toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const endTimeString = endTime ? endTime.toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            }) : null;

            const timeRange = endTimeString ? `${timeString} - ${endTimeString}` : timeString;

            return `
                <article class="event-card" onclick="viewEventDetails('${event.id}')">
                    <div class="event-priority priority-${event.priority || 'medium'}"></div>
                    <div class="event-content">
                        <div class="event-header">
                            <h3 class="event-title">${event.summary || event.title}</h3>
                            <div class="priority-label ${event.priority || 'medium'}">
                                ${event.priority === 'high' ? 'Hoch' :
                                  event.priority === 'low' ? 'Niedrig' : 'Mittel'}
                            </div>
                        </div>

                        <div class="event-meta">
                            <div class="event-date">
                                <span aria-hidden="true">üìÖ</span>
                                ${dateString}
                            </div>
                            <div class="event-time">
                                <span aria-hidden="true">‚è∞</span>
                                ${timeRange}
                            </div>
                        </div>

                        ${event.description ? `
                            <p class="event-description">${event.description}</p>
                        ` : ''}

                        ${event.location ? `
                            <div class="event-location">
                                <span aria-hidden="true">üìç</span>
                                ${event.location}
                            </div>
                        ` : ''}
                    </div>

                    <div class="event-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editEvent('${event.id}'); event.stopPropagation();" aria-label="Event bearbeiten">
                            <span aria-hidden="true">‚úèÔ∏è</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEvent('${event.id}'); event.stopPropagation();" aria-label="Event l√∂schen">
                            <span aria-hidden="true">üóëÔ∏è</span>
                        </button>
                    </div>
                </article>
            `;
        }).join('');

        container.innerHTML = `<div class="events-grid">${eventsHtml}</div>`;
    }

    async function loadStatistics() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            // Load today's events
            const todayResponse = await fetch(`/api/v1/events?date=${today}`, {
                headers: { 'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}` }
            });

            // Load week's events
            const weekResponse = await fetch(`/api/v1/events?start=${weekStart.toISOString().split('T')[0]}&end=${weekEnd.toISOString().split('T')[0]}`, {
                headers: { 'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}` }
            });

            // Load high priority events
            const highPriorityResponse = await fetch('/api/v1/events?priority=high', {
                headers: { 'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}` }
            });

            if (todayResponse.ok) {
                const todayEvents = await todayResponse.json();
                document.getElementById('todayEvents').textContent = todayEvents.length;
            }

            if (weekResponse.ok) {
                const weekEvents = await weekResponse.json();
                document.getElementById('weekEvents').textContent = weekEvents.length;
            }

            if (highPriorityResponse.ok) {
                const highPriorityEvents = await highPriorityResponse.json();
                document.getElementById('highPriorityEvents').textContent = highPriorityEvents.length;
            }

        } catch (error) {
            console.error('Fehler beim Laden der Statistiken:', error);
        }
    }

    function updateEventStats() {
        document.getElementById('totalEvents').textContent = allEvents.length;
    }

    function filterEvents() {
        const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
        const priorityFilter = document.getElementById('priorityFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;

        filteredEvents = allEvents.filter(event => {
            // Search filter
            const matchesSearch = !searchTerm ||
                (event.summary || event.title || '').toLowerCase().includes(searchTerm) ||
                (event.description || '').toLowerCase().includes(searchTerm);

            // Priority filter
            const matchesPriority = !priorityFilter || event.priority === priorityFilter;

            // Date filter
            let matchesDate = true;
            if (dateFilter) {
                const eventDate = new Date(event.start_time);
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);

                switch (dateFilter) {
                    case 'today':
                        matchesDate = eventDate.toDateString() === today.toDateString();
                        break;
                    case 'tomorrow':
                        matchesDate = eventDate.toDateString() === tomorrow.toDateString();
                        break;
                    case 'week':
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay() + 1);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        matchesDate = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case 'month':
                        matchesDate = eventDate.getMonth() === today.getMonth() &&
                                     eventDate.getFullYear() === today.getFullYear();
                        break;
                }
            }

            return matchesSearch && matchesPriority && matchesDate;
        });

        displayEvents(filteredEvents);
    }

    async function refreshEvents() {
        showToast('Events aktualisiert', 'Alle Events wurden neu geladen', 'success');
        await loadEvents();
        await loadStatistics();
    }

    function createNewEvent() {
        const today = new Date().toISOString().split('T')[0];
        const now = new Date().toTimeString().slice(0, 5);

        showModal('event-modal', 'Neues Event erstellen', `
            <form id="eventForm">
                <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                    <div>
                        <label for="eventTitle" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Titel *</label>
                        <input type="text" id="eventTitle" name="title" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                        <div>
                            <label for="eventDate" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Datum *</label>
                            <input type="date" id="eventDate" name="date" value="${today}" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);" required>
                        </div>
                        <div>
                            <label for="eventTime" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Zeit *</label>
                            <input type="time" id="eventTime" name="time" value="${now}" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);" required>
                        </div>
                    </div>
                    <div>
                        <label for="eventPriority" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Priorit√§t</label>
                        <select id="eventPriority" name="priority" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);">
                            <option value="low">Niedrig</option>
                            <option value="medium" selected>Mittel</option>
                            <option value="high">Hoch</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventDescription" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Beschreibung</label>
                        <textarea id="eventDescription" name="description" rows="3" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md); resize: vertical;"></textarea>
                    </div>
                    <div>
                        <label for="eventLocation" style="display: block; margin-bottom: var(--space-2); font-weight: var(--font-weight-medium);">Ort</label>
                        <input type="text" id="eventLocation" name="location" style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-base); border-radius: var(--radius-md);">
                    </div>
                </div>
            </form>
        `, [
            { text: 'Abbrechen', action: 'closeModal', class: 'btn-secondary' },
            { text: 'Event erstellen', action: 'createEvent', class: 'btn-primary' }
        ]);
    }

    async function createEvent() {
        const form = document.getElementById('eventForm');
        const formData = new FormData(form);

        const eventData = {
            title: formData.get('title'),
            start_time: `${formData.get('date')}T${formData.get('time')}:00`,
            priority: formData.get('priority'),
            description: formData.get('description') || '',
            location: formData.get('location') || ''
        };

        try {
            const response = await fetch('/api/v1/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}`
                },
                body: JSON.stringify(eventData)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            showToast('Event erstellt', `"${eventData.title}" wurde erfolgreich erstellt`, 'success');
            closeModal();
            await refreshEvents();

        } catch (error) {
            console.error('Fehler beim Erstellen des Events:', error);
            showToast('Fehler', 'Event konnte nicht erstellt werden: ' + error.message, 'error');
        }
    }

    async function viewEventDetails(eventId) {
        try {
            const response = await fetch(`/api/v1/events/${eventId}`, {
                headers: { 'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}` }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const event = await response.json();
            const startTime = new Date(event.start_time).toLocaleString('de-DE');
            const endTime = event.end_time ? new Date(event.end_time).toLocaleString('de-DE') : 'Offen';

            showModal('event-details', event.summary || event.title, `
                <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                    <div>
                        <strong>Startzeit:</strong> ${startTime}
                    </div>
                    <div>
                        <strong>Endzeit:</strong> ${endTime}
                    </div>
                    ${event.description ? `
                        <div>
                            <strong>Beschreibung:</strong><br>
                            ${event.description}
                        </div>
                    ` : ''}
                    ${event.location ? `
                        <div>
                            <strong>Ort:</strong> ${event.location}
                        </div>
                    ` : ''}
                    <div>
                        <strong>Priorit√§t:</strong>
                        <span class="priority-label ${event.priority || 'medium'}">${
                            event.priority === 'high' ? 'Hoch' :
                            event.priority === 'low' ? 'Niedrig' : 'Mittel'
                        }</span>
                    </div>
                </div>
            `, [
                { text: 'Bearbeiten', action: `editEvent('${eventId}')`, class: 'btn-secondary' },
                { text: 'L√∂schen', action: `deleteEvent('${eventId}')`, class: 'btn-danger' },
                { text: 'Schlie√üen', action: 'closeModal', class: 'btn-primary' }
            ]);

        } catch (error) {
            console.error('Fehler beim Laden der Event-Details:', error);
            showToast('Fehler', 'Event-Details konnten nicht geladen werden', 'error');
        }
    }

    async function deleteEvent(eventId) {
        if (!confirm('M√∂chten Sie dieses Event wirklich l√∂schen?')) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/events/${eventId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${window.CHRONOS_CONFIG.API_KEY}` }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            showToast('Event gel√∂scht', 'Event wurde erfolgreich gel√∂scht', 'success');
            closeModal();
            await refreshEvents();

        } catch (error) {
            console.error('Fehler beim L√∂schen des Events:', error);
            showToast('Fehler', 'Event konnte nicht gel√∂scht werden: ' + error.message, 'error');
        }
    }

    function editEvent(eventId) {
        // TODO: Implement edit functionality
        showToast('Bearbeiten', 'Event-Bearbeitung wird in K√ºrze verf√ºgbar sein', 'info');
    }
</script>

<style>
/* Events-specific styles */
.events-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    padding: var(--space-6);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-4);
}

.stat-card {
    background: var(--surface-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    transition: all var(--duration-base) var(--ease-out);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    font-size: var(--font-size-2xl);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-50);
    border-radius: var(--radius-md);
}

.stat-content {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    margin-bottom: var(--space-1);
}

.stat-number {
    display: block;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
}

.controls-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-4);
    flex-wrap: wrap;
}

.search-container {
    display: flex;
    align-items: center;
    background: var(--surface-primary);
    border: 1px solid var(--border-base);
    border-radius: var(--radius-md);
    overflow: hidden;
    flex: 1;
    max-width: 400px;
}

.search-container input {
    flex: 1;
    padding: var(--space-3);
    border: none;
    background: transparent;
    font-size: var(--font-size-sm);
}

.search-container button {
    padding: var(--space-3);
    border: none;
    background: var(--primary-500);
    color: white;
    cursor: pointer;
}

.filter-controls {
    display: flex;
    gap: var(--space-3);
}

.filter-controls select {
    padding: var(--space-3);
    border: 1px solid var(--border-base);
    border-radius: var(--radius-md);
    background: var(--surface-primary);
    font-size: var(--font-size-sm);
}

.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-5);
}

.event-card {
    background: var(--surface-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    position: relative;
    cursor: pointer;
    transition: all var(--duration-base) var(--ease-out);
}

.event-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.event-priority {
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    border-radius: var(--radius-lg) 0 0 var(--radius-lg);
}

.event-priority.priority-high {
    background: var(--danger-500);
}

.event-priority.priority-medium {
    background: var(--warning-400);
}

.event-priority.priority-low {
    background: var(--success-500);
}

.event-content {
    margin-left: var(--space-4);
}

.event-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-3);
}

.event-title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin: 0;
}

.event-meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.event-date,
.event-time,
.event-location {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.event-description {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin: var(--space-3) 0;
    line-height: var(--line-height-base);
}

.event-actions {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-4);
}

.empty-state {
    text-align: center;
    padding: var(--space-12);
    color: var(--text-muted);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: var(--space-4);
}

.empty-state h3 {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-2);
}

.loading-events {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    padding: var(--space-8);
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .controls-row {
        flex-direction: column;
        align-items: stretch;
    }

    .search-container {
        max-width: none;
    }

    .events-grid {
        grid-template-columns: 1fr;
    }

    .event-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
    }
}
</style>
{% endblock %}